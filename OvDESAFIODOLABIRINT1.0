using TMPro;
using UnityEngine;
using UnityEngine.SceneManagement;
using UnityEngine.UI;

public class MoveErica : MonoBehaviour
{
    public float velocidadeDaErica = 3f;
    public Animator animator;
    private Rigidbody rb;

    // ================= VIDA =================
    public Slider slider;
    public int vidaMaxima = 100;
    public int vidAtual;

    [Header("Controle de Vida por Tempo")]
    public float tempoPerdeVidaAndando = 1f;
    public float tempoGanhaVidaParado = 2f;
    private float timerVida = 0f;

    // ================= CHAVES =================
    public bool chaveA, chaveB, chaveC, chaveD, chaveE, chaveF;
    public bool chaveG, chaveH, chaveI, chaveJ, chaveK, chaveL;
    public bool chaveM, chaveN;

    // ================= RELÓGIOS =================
    public int relogios = 0;
    public TextMeshProUGUI relogiosText;

    // ================= CENARIOS =================
    public string GameOver;
    public string MenuFinalB;

    // ================= CRONOMETRO =================
    public TextMeshProUGUI cronometroText; // Referência ao texto do TextMeshPro
    public float tempo = 0f;  // Tempo inicial do cronômetro
    public bool contandoParaFrente = true; // Define se o tempo aumenta ou diminui
    //public float tempoMaximo;

    void Start()
    {
        rb = GetComponent<Rigidbody>();
        animator = GetComponent<Animator>();
        tempo = 0f;           // garante que começa do zero
        AtualizarTexto();     // força o texto a iniciar correto
        //tempoMaximo = tempo;

        vidAtual = vidaMaxima;

        if (slider != null)
        {
            slider.maxValue = vidaMaxima;
            slider.value = vidAtual;
        }
        // Carrega automaticamente se existir save
        //if (PlayerPrefs.HasKey("playerPosX"))
        //{
            //LoadGame();
        //}
    }

    void Update()
    {
        AtualizarAnimacao();
        ControleVidaPorMovimento();
        if (vidAtual <= 0)
        {
            SceneManager.LoadScene(GameOver);
        }
        //BOTOES
        if (Input.GetKeyDown(KeyCode.Z))//Salvar
        {
            SaveGame();
        }
        if (Input.GetKeyDown(KeyCode.X))//Carregar
        {
            LoadGame();
        }
        //CRONOMETRO
        if (contandoParaFrente)
        {
            // Cronômetro aumentando
            tempo += Time.deltaTime;
        }
        else
        {
            // Cronômetro diminuindo
            tempo -= Time.deltaTime;

            // Impede que o cronômetro fique negativo
            if (tempo < 0)
                tempo = 0;
        }
        //TEMPO MAXIMO DO CRONOMETRO
        if (tempo >= 420)
        {
            SceneManager.LoadScene(GameOver);
        }

        // Atualiza o texto com o tempo formatado
        AtualizarTexto();
    }

    public void AlternarContagem()
    {
        // Alterna entre aumentar e diminuir o tempo
        contandoParaFrente = !contandoParaFrente;
    }

    private void AtualizarTexto()
    {
        int minutos = Mathf.FloorToInt(tempo / 60);
        int segundos = Mathf.FloorToInt(tempo % 60);
        cronometroText.text = string.Format("TEMPO: {0:00}:{1:00}", minutos, segundos);
    }

    void FixedUpdate()
    {
        Movimento();
    }


    // ================= MOVIMENTO =================
    void Movimento()
    {
        float h = Input.GetAxis("Horizontal");
        float v = Input.GetAxis("Vertical");

        Vector3 direcao = new Vector3(h, 0, v).normalized;
        Vector3 velocidade = direcao * velocidadeDaErica;

        rb.velocity = new Vector3(velocidade.x, rb.velocity.y, velocidade.z);

        if (direcao != Vector3.zero)
            transform.forward = direcao;
    }

    void AtualizarAnimacao()
    {
        Vector3 vel = rb.velocity;
        vel.y = 0;

        animator.SetBool("Andar", vel.magnitude > 0.1f);
    }

    // ================= VIDA POR MOVIMENTO =================
    void ControleVidaPorMovimento()
    {
        Vector3 vel = rb.velocity;
        vel.y = 0;

        bool estaAndando = vel.magnitude > 0.1f;

        timerVida += Time.deltaTime;

        if (estaAndando && timerVida >= tempoPerdeVidaAndando)
        {
            PerdeVida(1);
            timerVida = 0f;
        }
        else if (!estaAndando && timerVida >= tempoGanhaVidaParado)
        {
            GanhaVida(1);
            timerVida = 0f;
        }
    }

    // ================= VIDA =================
    public void PerdeVida(int dano)
    {
        vidAtual -= dano;
        vidAtual = Mathf.Clamp(vidAtual, 0, vidaMaxima);
        AtualizaVida();

        if (vidAtual <= 0)
        {
            Debug.Log("O jogador morreu!");
        }
    }

    public void GanhaVida(int ganho)
    {
        vidAtual += ganho;
        vidAtual = Mathf.Clamp(vidAtual, 0, vidaMaxima);
        AtualizaVida();
    }

    void AtualizaVida()
    {
        if (slider != null)
            slider.value = vidAtual;
    }

    // ================= RELÓGIOS =================
    public void RelogiosText()
    {
        relogiosText.text = "RELÓGIOS: " + relogios;
    }

    // ================= SAVE E LOAD GAME =================
    void SaveGame()//Salva o jogo
     {
        PlayerPrefs.SetInt("relogios", relogios);
        PlayerPrefs.SetInt("chaveA", chaveA ? 1 : 0);
        PlayerPrefs.SetInt("chaveB", chaveB ? 1 : 0);
        PlayerPrefs.SetInt("chaveC", chaveC ? 1 : 0);
        PlayerPrefs.SetInt("chaveD", chaveD ? 1 : 0);
        PlayerPrefs.SetInt("chaveE", chaveE ? 1 : 0);
        PlayerPrefs.SetInt("chaveF", chaveF ? 1 : 0);
        PlayerPrefs.SetInt("chaveG", chaveG ? 1 : 0);
        PlayerPrefs.SetInt("chaveH", chaveH ? 1 : 0);
        PlayerPrefs.SetInt("chaveI", chaveI ? 1 : 0);
        PlayerPrefs.SetInt("chaveJ", chaveJ ? 1 : 0);
        PlayerPrefs.SetInt("chaveK", chaveK ? 1 : 0);
        PlayerPrefs.SetInt("chaveL", chaveL ? 1 : 0);
        PlayerPrefs.SetInt("chaveM", chaveM ? 1 : 0);
        PlayerPrefs.SetInt("chaveN", chaveN ? 1 : 0);
        PlayerPrefs.SetFloat("playerPosX", transform.position.x);
        PlayerPrefs.SetFloat("playerPosY", transform.position.y);
        PlayerPrefs.SetFloat("playerPosZ", transform.position.z);
        PlayerPrefs.SetFloat("tempo", tempo);
        PlayerPrefs.SetInt("vidaAtual", vidAtual);
        PlayerPrefs.Save();
        Debug.Log("Jogo salvo com sucesso!");
     }
     void LoadGame()//Carrega o jogo
     {
        if (!PlayerPrefs.HasKey("playerPosX"))
        {
            Debug.Log("Nenhum save encontrado!");
            return;
        }

        // Carrega relógios
        relogios = PlayerPrefs.GetInt("relogios", 0);
        chaveA = PlayerPrefs.GetInt("chaveA", 0) == 1;
        chaveB = PlayerPrefs.GetInt("chaveB", 0) == 1;
        chaveC = PlayerPrefs.GetInt("chaveC", 0) == 1;
        chaveA = PlayerPrefs.GetInt("chaveD", 0) == 1;
        chaveB = PlayerPrefs.GetInt("chaveE", 0) == 1;
        chaveC = PlayerPrefs.GetInt("chaveF", 0) == 1;
        chaveA = PlayerPrefs.GetInt("chaveG", 0) == 1;
        chaveB = PlayerPrefs.GetInt("chaveH", 0) == 1;
        chaveC = PlayerPrefs.GetInt("chaveI", 0) == 1;
        chaveA = PlayerPrefs.GetInt("chaveJ", 0) == 1;
        chaveB = PlayerPrefs.GetInt("chaveK", 0) == 1;
        chaveC = PlayerPrefs.GetInt("chaveL", 0) == 1;
        chaveC = PlayerPrefs.GetInt("chaveM", 0) == 1;
        chaveC = PlayerPrefs.GetInt("chaveN", 0) == 1;
        vidAtual = PlayerPrefs.GetInt("vidaAtual");
        tempo = PlayerPrefs.GetFloat("tempo");
        RelogiosText();

        // Carrega posição do player
        float x = PlayerPrefs.GetFloat("playerPosX");
        float y = PlayerPrefs.GetFloat("playerPosY");
        float z = PlayerPrefs.GetFloat("playerPosZ");

        // IMPORTANTE: zera a velocidade antes de mover
        rb.velocity = Vector3.zero;

        transform.position = new Vector3(x, y, z);



        Debug.Log("Jogo carregado com sucesso!");

        Camera.main.transform.position = new Vector3(transform.position.x, Camera.main.transform.position.y, transform.position.z);




     }

    // ================= COLETORES / PORTAS =================
    public void OnTriggerEnter(Collider other)
    {
        if (other.CompareTag("RelogiosPegos"))
        {
            relogios++;
            RelogiosText();
            other.gameObject.SetActive(false);
        }

        if (other.CompareTag("ChaveA")) { chaveA = true; other.gameObject.SetActive(false); }
        if (other.CompareTag("ChaveB")) { chaveB = true; other.gameObject.SetActive(false); }
        if (other.CompareTag("ChaveC")) { chaveC = true; other.gameObject.SetActive(false); }
        if (other.CompareTag("ChaveD")) { chaveD = true; other.gameObject.SetActive(false); }
        if (other.CompareTag("ChaveE")) { chaveE = true; other.gameObject.SetActive(false); }
        if (other.CompareTag("ChaveF")) { chaveF = true; other.gameObject.SetActive(false); }
        if (other.CompareTag("ChaveG")) { chaveG = true; other.gameObject.SetActive(false); }
        if (other.CompareTag("ChaveH")) { chaveH = true; other.gameObject.SetActive(false); }
        if (other.CompareTag("ChaveI")) { chaveI = true; other.gameObject.SetActive(false); }
        if (other.CompareTag("ChaveJ")) { chaveJ = true; other.gameObject.SetActive(false); }
        if (other.CompareTag("ChaveK")) { chaveK = true; other.gameObject.SetActive(false); }
        if (other.CompareTag("ChaveL")) { chaveL = true; other.gameObject.SetActive(false); }
        if (other.CompareTag("ChaveM")) { chaveM = true; other.gameObject.SetActive(false); }
        if (other.CompareTag("ChaveN")) { chaveN = true; other.gameObject.SetActive(false); }


        //PORTAS
        //PORTANFIM
        if (other.CompareTag("PortaN"))//Abre a Porta N
        {
            if (relogios >= 13)
            {
                other.gameObject.SetActive(false);
                SceneManager.LoadScene(MenuFinalB);
            }
        }
        //PORTAM
        if (other.CompareTag("PortaM"))//Abre a Porta M
        {
            if (chaveM == true)
            {
                other.gameObject.SetActive(false);
            }
        }
        //PORTAL
        if (other.CompareTag("PortaL"))//Abre a Porta L
        {
            if (chaveL == true)
            {
                other.gameObject.SetActive(false);
            }
        }
        //PORTAK
        if (other.CompareTag("PortaK"))//Abre a Porta K
        {
            if (chaveK == true)
            {
                other.gameObject.SetActive(false);
            }
        }
        //PORTAJ
        if (other.CompareTag("PortaJ"))//Abre a Porta J
        {
            if (chaveJ == true)
            {
                other.gameObject.SetActive(false);
            }
        }
        //PORTAI
        if (other.CompareTag("PortaI"))//Abre a Porta I
        {
            if (chaveI == true)
            {
                other.gameObject.SetActive(false);
            }
        }
        //PORTAH
        if (other.CompareTag("PortaH"))//Abre a Porta H
        {
            if (chaveH == true)
            {
                other.gameObject.SetActive(false);
            }
        }
        //PORTAG
        if (other.CompareTag("PortaG"))//Abre a Porta G
        {
            if (chaveG == true)
            {
                other.gameObject.SetActive(false);
            }
        }
        //PORTAF
        if (other.CompareTag("PortaF"))//Abre a Porta F
        {
            if (chaveF == true)
            {
                other.gameObject.SetActive(false);
            }
        }
        //PortaE
        if (other.CompareTag("PortaE"))//Abre a Porta E
        {
            if (chaveE == true)
            {
                other.gameObject.SetActive(false);
            }
        }
        //PortaD
        if (other.CompareTag("PortaD"))//Abre a Porta D
        {
            if (chaveD == true)
            {
                other.gameObject.SetActive(false);
            }
        }
        //Porta C
        if (other.CompareTag("PortaC"))//Abre a Porta C
        {
            if (chaveC == true)
            {
                other.gameObject.SetActive(false);
            }
        }

        //Porta B
        if (other.CompareTag("PortaB"))//Abre a Porta B
        {
            if (chaveB == true)
            {
                other.gameObject.SetActive(false);
            }
        }

        //Porta A
        if (other.CompareTag("PortaA"))//Abre a Porta A
        {
            if (chaveA == true)
            {
                other.gameObject.SetActive(false);
            }
        }
    }
    
}
